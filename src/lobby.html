<!DOCTYPE html>
<html>
<head>
  <title></title>
  <style>
    .invite {
      color: blue;
      cursor: pointer;
    }
    .invite.sent {
      color: red;
    }
    .invite-status {
      color: gray;
      font-style: italic;
    }
    #leave-party {
      color: blue;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h3>My Id:</h3>
  <div id="my-id"></div>
  <br>
  <br>

  <div id="invitations"></div>


  <div>
    <h2>Player List:</h2>
    <ul id="player-list"></ul>
  </div>

  <div>
    <h3>My Party:</h3>
    <ul id="party-list"></ul>
  </div>

  <ul id="player-list"></ul>
  <div id="leave-party">Leave Party</div>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    const socket = io();

    socket.on('player-joined-or-left', players => {
      const $list = $('#player-list').empty();
      players.forEach(({ playerName, testValue }) => {
        $list.append(`
          <li>
            <span class="player-test">${testValue}</span>
            <span class="player-name">${playerName}</span>
            <span class="invite">Invite</span>
            <span class="invite-status"></span>
          </li>
        `);
      });
    });

    socket.on('my-id', id => { 
      $('#my-id').text(id);
      window.playerID = id;
    });

    socket.on('receiveInvite', sender => {
      $('#invitations').prepend(`
        <div class="invitation">
          <span class="invite-sender">${sender}</span> <span>wants to join your party!</span>
          <button class="accept">Accept</button>
          <button class="reject">Reject</button>
        </div>
      `);
    });

    socket.on('accept', playerWhoAccepted => {
      updateInviteStatus(playerWhoAccepted, 'Invite accepted!');
    });

    socket.on('reject', playerWhoRejected => {
      updateInviteStatus(playerWhoRejected, 'Invite declined');
    });

    socket.on('party-update', partyPlayers => {
      window.partyPlayers = partyPlayers;
      const $list = $('#party-list').empty();
      partyPlayers.forEach(({ playerName, testValue, isPartyLeader }) => {
        const $li = $(`<li>
          <span class="player-test">${testValue}</span>
          <span class="player-name">${playerName}</span>
        </li>`);

        if (isPartyLeader) {
          $li.append(`<span class="party-leader">KING</span>`);
        }

        $list.append($li);
      });
    });

    socket.on('left-party', disbandParty);


    $('#player-list').on('click', '.invite:not(.sent)', function() {
      $(this).addClass('sent');
      $(this).closest('li').find('.invite-status').text('Invite pending...');
      const playerToInvite = $(this).prev().text().trim();
      socket.emit('invite', { playerToInvite, sender: window.playerID });
    });

    $('#invitations').on('click', '.accept', function() {
      const senderID = $(this).closest('.invitation').find('.invite-sender').text().trim();
      socket.emit('accept', { senderID, playerWhoAccepted: playerID });
    });

    $('#invitations').on('click', '.reject', function() {
      const senderID = $(this).closest('.invitation').find('.invite-sender').text().trim();
      socket.emit('reject', { senderID, playerWhoRejected: playerID });
      $(this).closest('.invitation').remove();
    });

    $('#leave-party').click(function() {
      const partyLeader = $('#party-list').find('.party-leader').closest('li').find('.player-name').text().trim()
      socket.emit('leave-party', { partyLeader, playerWhoWantsToLeave: playerID });
    });


    function updateInviteStatus(idTarget, status) {
      const $playerRow = $('#player-list').find(`.player-name:contains(${idTarget})`).closest('li');
      $playerRow.find('.invite-status').text(status);
      if (status === 'Invite declined') {
        $playerRow.find('.invite').removeClass('sent');
      }
    }

    function disbandParty() {
      window.partyPlayers = null;
      $('#party-list').empty();
    }


    // Once the last player has left the party then the party module should reset
    // As soon as a player is accepted into a party they should not see the Invite links
    // What happens if a user has several invitations? If they accept one then the others should be removed
    // What happens if the party leader disconnects? The whole part should be disbanded with a message
    // What happens if a party member disconnects? 


  </script>

</body>
</html>